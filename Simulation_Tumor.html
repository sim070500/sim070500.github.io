<!DOCTYPE html>
<html lang="en">

<head>

    <!-- Basic Page Needs
    ================================================== -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Tumor Morphology | EJ Blog</title>

    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">

    <!-- Mobile Specific Metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Favicon
    ================================================== -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon.png">

    <!-- Stylesheets
    ================================================== -->
    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/responsive.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
      }
    });
  </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
        type="text/javascript"></script>

</head>

<body>

    <header id="masthead" class="site-header site-header-white">
        <nav id="primary-navigation" class="site-navigation">
            <div class="container">



                <div class="navbar-header">

                    <a class="site-title"><span>EJ Blog</span>- Exploring in complex system</a>

                </div><!-- /.navbar-header -->

                <div class="collapse navbar-collapse" id="agency-navbar-collapse">

                    <ul class="nav navbar-nav navbar-right">


                        <li><a href="index.html">Home</a></li>

                        <li><a href="profile.html">Profile</a></li>
                        <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Researches<i
                                    class="fa fa-caret-down hidden-xs" aria-hidden="true"></i></a>

                            <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                                <li><a href="Traffic_Model.html">Traffic Model</a></li>
                                <li><a href="Tumor_Morphology.html">Tumor Morphology</a></li>
                                <!--<li><a href="MIPS.html">Motility Induced Phase Seperation</a></li>-->

                            </ul>

                        </li>

                        <li><a href="Publication.html">Publication</a></li>



                    </ul>

                </div>

            </div>
        </nav><!-- /.site-navigation -->
    </header><!-- /#mastheaed -->

    <div id="hero" class="hero overlay subpage-hero portfolio-hero-tumor">
        <div class="hero-content">
            <div class="hero-text">
                <h1>Tumor Morphology</h1>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                    <li class="breadcrumb-item active">Tumor Morphology</li>
                </ol>
            </div><!-- /.hero-text -->
        </div><!-- /.hero-content -->
    </div><!-- /.hero -->

    <main id="main" class="site-main">
        <section class="site-section subpage-site-section section-portfolio" style="background-color: #FFFFFF">
            <div class="container">
                <ul class="portfolio-sorting list-inline text-center">
                    <li><a href="Tumor_Morphology.html" class="btn btn-gray" data-group="introduction">Introduction</a>
                    </li>
                    <li><a href="Simulation_Tumor.html" class="btn btn-gray" data-group="codeidentical">Simulation
                            Process</a></li>
                </ul><!-- /.portfolio-sorting  -->

                <div class="row" data-groups='["introduction"]'>
                    <div style="padding: 10px 0px;"></div>
                    <div class="text-center">
                        <h2 class="heading-separator">Simulation Process</h2>
                        <p class="subheading-text">How to build up a simulation to simulate the profile of a tumor?
                        </p>
                    </div>
                    <div style="padding: 10px 0px;"></div>

                </div>
                <div class="row">
                    <div style="padding: 10px 0px;"></div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">
                        <p style="font-size:130%; color: black; line-height:130%">These are the jupyter-notebook code we
                            present here
                            and the complete python code for finding other properties.</p>

                        <div style="padding: 8px 0px;"></div>
                        <ul>
                            <li><b>jupyter-notebook code</b>
                                <a class="downloadfile-bg" href="Traffic/jupytercode.ipynb"
                                    download="traffic_bando.ipynb" target="_blank"><i class="fa fa-file"></i></a>
                            </li>
                            <li><b>python code</b>
                                <a href="tumor/tumor.zip" download="tumor.zip" target="_blank"><i
                                        class="fa-brands fa-python"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="row" data-groups='["introduction"]'>

                    <div style="padding: 10px 0px;"></div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">

                            <span class="tab"></span> The difficulty in simulating a avascular tumor cell is: how to
                            simulate a system with the boundary condition fixed at infinity $u(\pm \infty) = C_0$? It is
                            impossible to create a parameter space with infinite size. To overcome this problem, we need
                            to transform the original parameter space into a finite space. In our work, we choose a
                            hyperbolic transformation. That is assuming the original space is denoted by $x$, and the
                            transformed space $\eta$, say eta-space, would be
                            $$
                            \eta = \tanh\left(\frac{x}{x_0}\right).
                            $$
                            By doing so, the boundary condition will turn out to be $u(x = \pm \infty) = u(\eta = \pm 1)
                            = C_0$. However, since hyperbolic tangent is not a linear function, it is necessary to be
                            cautious when we conduct the simulation. To be more specific, when the system moves from
                            $\eta$ to $\eta+0.1$, the trajectory in real space moves from $x_0\text{arctanh}(\eta)$ to
                            $x_0\text{arctanh}(\eta+0.1)$. For $\eta = 0.1$ and $0.6$, the system moves $0.1x_0$ and
                            $0.17x_0$, respectively. Apparently, as the system moves far from the origin, when they
                            cross a unit step in eta-space, they cross a huge step in real space. To trap the system
                            near the origin such that the crossing step is linear between real space and eta-space, we
                            set $x_0 = 400$ in our simulation. See Fig. 1.
                        </p>
                        <figure class="text-center" id="myfigure">
                            <img src="./tumor/diffx0.svg" width="800" height="400" />
                            <figcaption>Fig. 1 - Relation between eta space and real space when $x_0 = 1$ and $x_0=400$
                            </figcaption>
                        </figure>

                    </div>
                </div>

                <div class="row" data-groups='["introduction"]'>

                    <div style="padding: 10px 0px;"></div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">

                            <span class="tab"></span>Now, we know how to simulate in eta-space. However, how do we find
                            a spatial derivative precisely? Remind that if the system is periodic, the best way to
                            simulate is using Fourier transformation and calculate the derivative in Fourier space. What
                            is the case in current simulation? Fortunately, it we transform the laplacian operator into
                            the eta-space, the answer appears. That is,
                            $$
                            \begin{align*}
                            \nabla^2 &= \frac{\partial }{\partial x}\frac{\partial }{\partial x} = \frac{\partial
                            }{\partial x}\left(\frac{\partial \eta}{\partial x}\frac{\partial
                            }{\partial \eta}\right) \\[1em]
                            &= \frac{\partial }{\partial x}\left(\frac{\text{sech}^2(x/x_0)}{x_0}\frac{\partial
                            }{\partial \eta}\right) \\[1em]
                            &= \frac{\partial }{\partial x}\left(\frac{1-\eta^2}{x_0}\frac{\partial }{\partial
                            \eta}\right) \\[1em]
                            &= \left(\frac{(1-\eta^2)}{x_0^2}\frac{\partial }{\partial
                            \eta}\right)\left((1-\eta^2)\frac{\partial }{\partial \eta}\right) \\[1em]
                            &= \frac{(1-\eta^2)}{x_0^2}\hat{\cal{L}},
                            \end{align*}
                            $$
                            where $\hat{\cal{L}}$ is the Legendre operator. Apparently, <b><u>the best way to find
                                    spatial derivative is in Legendre space in this case</u></b>. Therefore, the most
                            important thing in this simulation is <b><u>finding the Legendre coefficients of all
                                    functions</u></b>.To get the solution as precise as possible, we utilize the
                            orthonormal property of Legendre polynomial $P_m(x)$,
                            $$
                            \int_{-1}^1 P_m(x)P_n(x)dx = \frac{2}{2n+1}\delta_{mn}
                            $$
                            and employ the <i>Gaussian-Legendre quadrature</i> to find the integration. See <a
                                href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Legendre_quadrature" target="_blank"
                                style="text-decoration:none;color:blue;">Wikipidia</a> for more details.
                            In our simulations, we split the space in $4096$ data point, which means we need to process
                            a $4096\times 4096$ matrix multiplication in each simulation step. The size of the matrix
                            suggest us use GPU simulation to accelerate. In the following, I will present some important
                            parts in my program and briefly talk about the codes.
                        </p>


                    </div>
                </div>

            </div>
        </section><!-- /.section-features -->

        <section class="site-section section-features" style="background-color: gainsboro">
            <div class="container">
                <div class="text-center">
                    <h2 class="heading-separator">Presentation of my code</h2>
                </div>
                <div class="row">

                    <div style="padding:10px 0px;"></div>

                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">

                            <span class="tab"></span>First of all, to simulate a function precisely, it would be better
                            to transform between different spaces as less as possible. Therefore, since we need the
                            information of the function at the site of the root of Legendre polynomial when we employ
                            Gaussian-Legendre quadrature, <b><u>we simulate all things on the site of the root of
                                    Legendre polynomial</u></b>, which means the initial conditions of tumor cell
                            density and nutrient density is set on the site of the root of Legendre polynomial.
                            Fortunately, <i>Numpy</i> provides a package for us to find the root of Legendre polynomial.
                            The code of finding root and the weighting function $w$ is (Notice that finding $w$ and root
                            is time consuming, if you do not change the split number of the space, I suggest you save
                            the arrays of $w$ and roots):
                        </p>
                        <pre>def findlagendreweight(split):
    if os.path.isfile('root_{}.npy'.format(split)):
        Broots = np.load('roots_{}.npy'.format(split))
    else:
        A = np.zeros(split+1)
        A[-1] = 1
        B = npl.Legendre(A)
        Broots = B.roots()
        np.save('roots_{}.npy'.format(split), Broots)
    
    # now and after are used to find the derivative of legendre polynomial
    now = np.zeros(split+1)
    now[-1] = 1
    after = np.zeros(split+1)
    after[-2] = 1
    pder = split*(Broots*npl.legval(Broots, now)-npl.legval(Broots, after))/(Broots**2 -1)
    warray = 2/((1-Broots**2)*(pder**2))
    np.save('warray_{}.npy'.format(split), warray)
                        
    return warray</pre>
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">

                            <span class="tab"></span>Next, since we need to multiply legendre polynomial to find the
                            coefficient, we calculate all polynomial value in a matrix and save it. <b><u>It is worth to
                                    note that this process is the most time consuming in this simulation. I strongly
                                    suggest you save the array first</u></b>.
                        </p>
                        <pre>legendrearray = np.zeros(split+1)
legendrearray = []
for i in range(0, split+1):
    nowcoeff = np.zeros(i+1)
    nowcoeff[-1] = 1
    legendrearray.append(npl.legval(xaxis, nowcoeff))
                        
legendrearray = np.array(legendrearray)
np.save('./legendrearray_{}.npy'.format(split), legendrearray)</pre>
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">

                            <span class="tab"></span>Then, you can calculate the derivative and use the fourth-order
                            Runge-Kutta method to simulate. The result should be something like Fig. 2
                        </p>
                        <figure class="text-center" id="myfigure">
                            <img src="./assets/img/all_evolve.svg" width="800" height="400" />
                            <figcaption>Fig. 2 - The evolution of tumor cells and nutrient density for $(C_0, a, \gamma,
                                M, D_u, \bar{u}) = (8, 0.5, 0.2, 2.1, 10, 2)$</figcaption>
                        </figure>



                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">

                            <span class="tab"></span>
                            However, as you see, the system always move out. Since the simulation should not be taken
                            far from the origin, we trap the peak of the tumor cell density profile and calculate the
                            velocity of it. By transforming the system in the a moving frame with the opposite direction
                            of the velocity, the tumor profile will stay stationary (One can imagine it as a treadmill
                            ). There are two points we should be
                            cautious:
                        <ol>
                            <li> The moving frame should be used after two surfaces are generated to avoid interactions
                                between them</li>
                            <li> The moving frame has opposite direction in positive $\eta$ and $-\eta$ since tumor
                                moves along different directions in these two region.</li>
                        </ol>
                        </p>
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">
                            <span class="tab"></span>To track the position of the peak of the tumor profile, we
                            calculate the position for the
                            zero
                            point of spatial derivative of tumor profile. Since we know the legendre coefficients, we
                            can
                            calculate the value of the function anywhere. The process uses Newton method to find the
                            zero
                            point of $\partial n/\partial x= 0$. See <a
                                href="https://en.wikipedia.org/wiki/Newton%27s_method" target="_blank"
                                style="text-decoration:none;color:blue;">Wikipidia</a> for more details about Newton
                            method.
                        </p>
                        <pre>def findmax( function, coeff, eigvalue1, eigvalue2, startx = 0):
x = startx
alson = coeff*eigvalue1
nminuscoeff = np.zeros(len(eigvalue1))
nminuscoeff[0:len(nminuscoeff)-1] = coeff[1:len(coeff)]*eigvalue1[1:len(eigvalue1)]
while True:
    single = npl.legval(x, alson)*x/(x**2 -1) + npl.legval(x, nminuscoeff)*(-1)/(x**2-1)
    if abs(single) < 10**(-12): 
        break 
    
    double=single*2*x/(1-x**2) + npl.legval(x, coeff*eigvalue2)/(1-x**2)
    dx=single/double
    x -=dx 
return x</pre>
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">
                            <span class="tab"></span>Finally, if you simulate the system until the profile is unchanged,
                            you get the steady
                            solution of the system. Or, you can utilize the evolution equation of nutrient to help you
                            double check the profile. That is, for $\partial u/ \partial t=0$,
                            $$
                            n = \frac{D_u \nabla^2 u }{bA(u)}.
                            $$
                            If the simulation profile of $u$ and $n$ satisfy the equality, we can argue that the system
                            has reached its steady state.
                        </p>
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">
                            <span class="tab"></span>Then, if you are interested in finding the instability of the
                            perturbation, you can applied
                            a perturbation with wave number $k$ on $y$ direction to the steady state. For simplicity, I
                            used the $10^{-6}$ times the steady state as the initial state of the perturbation
                            $n_1(t=0)$. By evolve the perturbation until $n_1(t=t)/n_1(t=t+dt)$ reaches a same constant
                            for non-zero $n$ at each site, we can argue that profile is shape preserving. The shape
                            preserving perturbation is shown in Fig. 3.
                        </p>
                        <figure class="text-center" id="myfigure">
                            <img src="./assets/img/ploteigen.svg" width="800" height="400" />
                            <figcaption>Fig. 3 - Shape preserving eigenfunction. The coefficients used in the simulation
                                are $(C_0, a, \gamma,
                                M, D_u, \bar{u}) = (6, 0.5, 0.2, 2.1, 10, 2)$ for $k=0.0042$</figcaption>
                        </figure>
                        <p style="font-size:180%; color: black; line-height:130%" class="align-distribute">
                            <span class="tab"></span>Finally, tracking the peak of the shape preserving profile, you can
                            know it grows or decay,
                            and judge the instability of the steady state. By conducting a lot of wave numbers, you can
                            know the stability of steady tumor at that boundary condition. Changing the boundary
                            condition, you can plot all the phase diagram by yourself!
                        </p>


                    </div>
                </div>





            </div>
        </section><!-- /.section-features -->











    </main><!-- /#main -->

    <footer id="colophon" class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3 col-sm-4 col-xs-6">
                    <a class="site-title"><span>EJ </span> - A Complex System Researcher</a>
                    <p>I focus on nonlinear dynamics and pattern formation in live systems</p>
                    <p>I love reading Japanese books, and Japanese animate. Some reviews relating to my favorite books
                        are in progress </p>
                </div>
                <div class="col-lg-offset-4 col-md-3 col-sm-4 col-md-offset-2 col-sm-offset-0 col-xs-6 ">
                    <h3>Keep in touch</h3>
                    <ul class="list-unstyled contact-links">
                        <li><i class="fa fa-envelope" aria-hidden="true"></i><a
                                href="mailto:sim108022503@gapp.nthu.edu.tw">sim108022503@gapp.nthu.edu.tw</a></li>
                        <li><i class="fa fa-envelope" aria-hidden="true"></i><a
                                href="mailto:yichieh_lai@mx.nthu.edu.tw">yichieh_lai@mx.nthu.edu.tw</a></li>
                    </ul>
                </div>
                <div class="clearfix visible-xs"></div>
            </div>
        </div>
        <div class="copyright">
            <div class="container">
                <div class="row">
                    <div class="col-xs-8">
                        <div class="social-links">
                            <a class="github-bg" href="https://github.com/sim070500" target="_blank"><i
                                    class="fa fa-github"></i></a>
                        </div><!-- /.social-links -->
                    </div>
                    <div class="col-xs-4">
                        <div class="text-right">
                            <p>&copy; AgencyPerfect</p>
                            <p>All Rights Reserved</p>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.copyright -->
    </footer><!-- /#footer -->



    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/bootstrap-select.min.js"></script>
    <script src="assets/js/jquery.slicknav.min.js"></script>
    <script src="assets/js/jquery.countTo.min.js"></script>
    <script src="assets/js/jquery.shuffle.min.js"></script>
    <script src="assets/js/script.js"></script>

</body>

</html>